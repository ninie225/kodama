{% extends 'base.html.twig' %}

{% block title %}
    {% if is_logged_in %}
        Mon profil
    {% else %}
        Formulaire de connexion
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/login.css') }}">
{% endblock %}

{% block body %}
<div class="login-page d-flex flex-column">
    {% include 'navbar.html.twig' %}

    <div class="d-flex flex-column justify-content-start align-items-center text-center text-white px-3">
        <h1 class="display-4 text-uppercase fw-bold">
            {% if is_logged_in %}
                Mon profil
            {% else %}
                Formulaire de connexion
            {% endif %}
        </h1>

        <div class="container flex-grow-1 d-flex align-items-center mb-5">
            <div class="row align-items-center w-100">

                {# Si utilisateur connecté #}
                {% if is_logged_in %}
                    <div class="bg-white text-black p-5 my-3 rounded-4 border border-light col-md-8 offset-md-2">

                        {# Barre d’actions #}
                        <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                            <a href="{{ path('app_logout') }}" class="btn btn-outline-danger rounded-5">Se déconnecter</a>

                            {# Si utilisateur client : accès à l'historique de ses commandes #}
                            {% if 'ROLE_CLIENT' in user.roles %}
                                <a href="{{ path('app_commandes_client') }}" class="btn btn-outline-primary rounded-5">
                                    Historique des commandes
                                </a>
                            {% endif %}

                            {# Si utilisateur chef : peut seulement voir les commandes #}
                            {% if 'ROLE_CHEF' in user.roles %}
                                <a href="{{ path('app_commandes') }}" class="btn btn-outline-warning rounded-5">
                                    Voir les commandes
                                </a>
                            {% endif %}

                            {# Si utilisateur admin : accès à la gestion des plats + utilisateurs #}
                            {% if 'ROLE_ADMIN' in user.roles %}
                                <a href="{{ path('app_dashboard') }}" class="btn btn-outline-primary rounded-5">
                                    Gestion des plats
                                </a>
                                <a href="{{ path('app_dashboard_utilisateurs') }}" class="btn btn-outline-warning rounded-5">
                                    Gestion des utilisateurs
                                </a>
                            {% endif %}
                        </div>

                        {#Titre de la section #}
                        <h2 class="fw-bold mb-4">
                            {% if 'ROLE_CLIENT' in user.roles %}
                                Mon profil client
                            {% elseif 'ROLE_CHEF' in user.roles %}
                                Espace chef
                            {% elseif 'ROLE_ADMIN' in user.roles %}
                                Espace administrateur
                            {% endif %}
                        </h2>

                        {# Profil utilisateur #}
                        <form method="post" action="{{ path('app_profile_update') }}">
                            <div class="mb-3">
                                <label for="inputEmail" class="text-start d-block fw-bold">Email</label>
                                <input type="email" value="{{ user.email }}" name="email" id="inputEmail" class="form-control" readonly>
                            </div>

                            {# Infos modifiables uniquement pour le client #}
                            {% if 'ROLE_CLIENT' in user.roles %}
                                <div class="mb-3">
                                    <label for="inputNom" class="text-start d-block fw-bold">Nom</label>
                                    <input type="text" value="{{ user.nom }}" name="nom" id="inputNom" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="inputPrenom" class="text-start d-block fw-bold">Prénom</label>
                                    <input type="text" value="{{ user.prenom }}" name="prenom" id="inputPrenom" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="inputTelephone" class="text-start d-block fw-bold">Téléphone</label>
                                    <input type="text" value="{{ user.telephone }}" name="telephone" id="inputTelephone" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="inputAdresse" class="text-start d-block fw-bold">Adresse</label>
                                    <input type="text" value="{{ user.adresse }}" name="adresse" id="inputAdresse" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="inputCp" class="text-start d-block fw-bold">Code postal</label>
                                    <input type="text" value="{{ user.cp }}" name="cp" id="inputCp" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="inputVille" class="text-start d-block fw-bold">Ville</label>
                                    <input type="text" value="{{ user.ville }}" name="ville" id="inputVille" class="form-control">
                                </div>
                            {% endif %}

                            {# Changement mot de passe #}
                            <div class="mb-3">
                                <label for="inputPassword" class="text-start d-block fw-bold">Nouveau mot de passe</label>
                                <input type="password" name="password" id="inputPassword" class="form-control" placeholder="Nouveau mot de passe">
                            </div>
                            <div class="mb-3">
                                <label for="inputPasswordConfirm" class="text-start d-block fw-bold">Confirmer le mot de passe</label>
                                <input type="password" name="password_confirm" id="inputPasswordConfirm" class="form-control" placeholder="Confirmer le mot de passe">
                            </div>

                            <input type="hidden" name="_csrf_token" value="{{ csrf_token('update_profile') }}">

                            <button type="submit" class="btn btn-outline-success btn-lg rounded-5 mt-3">
                                Mettre à jour
                            </button>
                        </form>
                    </div>

                {# Si l'utilisateur n'est pas connecté #}
                {% else %}
                    <h1 class="h3 my-5 font-weight-normal">Connectez-vous</h1>

                    <form method="post" class="bg-white text-black p-4 rounded-4 border border-light col-md-6 offset-md-3">
                        {% if error %}
                            <div class="alert alert-danger">{{ error.messageKey|trans(error.messageData, 'security') }}</div>
                        {% endif %}

                        <label for="inputEmail" class="text-start d-block fw-bold">Email</label>
                        <input type="email" name="email" id="inputEmail" class="form-control" autocomplete="email" required autofocus placeholder="Entrez votre email">

                        <label for="inputPassword" class="text-start d-block fw-bold mt-4">Mot de passe</label>
                        <input type="password" name="password" id="inputPassword" class="form-control" autocomplete="current-password" required placeholder="*********">

                        <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

                        <div class="text-start mt-2">
                            <a href="{{ path('app_forgot_password_request') }}" class="btn p-0 m-0 link">
                                Mot de passe oublié ?
                            </a>
                        </div>

                        <div class="d-grid gap-2 col-6 mx-auto mt-3">
                            <button class="btn btn-outline-success btn-lg rounded-5" type="submit">
                                Se connecter
                            </button>
                        </div>
                    </form>

                    <a href="{{ path('app_inscription') }}" class="btn text-center fw-bold mt-3 link">
                        Pas encore de compte ?
                    </a>
                {% endif %}
            </div>
        </div>

        {# Message flash #}
        <div class="col-6">
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="container alert alert-{{ label }} alert-gradient alert-dismissible fade show shadow" role="alert">
                        <strong>✓</strong> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
